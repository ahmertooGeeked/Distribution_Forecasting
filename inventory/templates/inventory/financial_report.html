{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark">Financial Health</h1>
            <p class="text-muted small mb-0">Performance Report (Last 30 Days)</p>
        </div>
        <button class="btn btn-light border shadow-sm" onclick="window.print()">
            <i class="fa-solid fa-print me-2"></i> Print Report
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted fw-bold small">Total Revenue</h6>
                    <h3 class="fw-bold text-dark mt-2">{{ system_settings.currency_symbol }} {{ revenue|floatformat:2 }}</h3>
                    <small class="text-success"><i class="fa-solid fa-arrow-up"></i> Sales collected</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted fw-bold small">Cost of Goods (COGS)</h6>
                    <h3 class="fw-bold text-dark mt-2">{{ system_settings.currency_symbol }} {{ cogs|floatformat:2 }}</h3>
                    <small class="text-muted">Product purchase costs</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="text-uppercase text-danger fw-bold small">Spoilage Loss</h6>
                    <h3 class="fw-bold text-danger mt-2">- {{ system_settings.currency_symbol }} {{ spoilage_loss|floatformat:2 }}</h3>
                    <small class="text-danger opacity-75">Value of wasted stock</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100 text-white"
                 style="background: {% if net_profit >= 0 %}linear-gradient(135deg, #059669, #10b981){% else %}linear-gradient(135deg, #dc2626, #ef4444){% endif %};">
                <div class="card-body">
                    <h6 class="text-uppercase opacity-75 fw-bold small">Net Profit</h6>
                    <h3 class="fw-bold mt-2">{{ system_settings.currency_symbol }} {{ net_profit|floatformat:2 }}</h3>
                    <span class="badge bg-white bg-opacity-25 text-white border border-white border-opacity-25">
                        {{ margin_percent }}% Margin
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark">Profitability Breakdown</h5>
                </div>
                <div class="card-body">
                    <label class="fw-bold small text-muted mb-2">Revenue Distribution</label>
                    <div class="progress" style="height: 30px; border-radius: 15px;">
                        {% if revenue > 0 %}
                            <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ cogs|divisibleby:revenue }}%; background-color: #94a3b8 !important;" title="Cost of Goods">COGS</div>
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 10%;" title="Spoilage">Waste</div>
                            <div class="progress-bar bg-success" role="progressbar" style="width: 40%;" title="Profit">Profit</div>
                        {% else %}
                            <div class="w-100 text-center text-muted small align-self-center">No revenue data available</div>
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        <canvas id="profitChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark">Expense Analysis</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <span>Product Costs</span>
                        <span class="fw-bold">{{ system_settings.currency_symbol }} {{ cogs|floatformat:2 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <span class="text-danger">Spoilage / Waste</span>
                        <span class="fw-bold text-danger">{{ system_settings.currency_symbol }} {{ spoilage_loss|floatformat:2 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 bg-light">
                        <span class="fw-bold">Total Expenses</span>
                        <span class="fw-bold">{{ system_settings.currency_symbol }} {{ total_expenses|floatformat:2 }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('profitChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Revenue', 'Expenses (COGS + Waste)', 'Net Profit'],
            datasets: [{
                label: 'Amount',
                data: [{{ revenue }}, {{ total_expenses }}, {{ net_profit }}],
                backgroundColor: [
                    '#4f46e5', // Revenue (Purple)
                    '#fb7185', // Expenses (Red-ish)
                    '{% if net_profit >= 0 %}#10b981{% else %}#ef4444{% endif %}'  // Profit (Green/Red)
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2] } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}
